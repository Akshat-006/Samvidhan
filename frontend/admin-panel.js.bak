const API_BASE = 'http://localhost:3000';

// Function to safely format date
function formatDate(dateString) {
  if (!dateString) return 'Date not available';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return 'Invalid date';
    }
    
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return 'Date format error';
  }
}

// Function to get status badge class
function getStatusBadgeClass(status) {
  if (!status) return 'badge-secondary';
  
  switch (status.toLowerCase()) {
    case 'pending': return 'badge-warning bg-warning';
    case 'approved': return 'badge-success bg-success';
    case 'rejected': return 'badge-danger bg-danger';
    case 'in-progress': return 'badge-info bg-info';
    default: return 'badge-secondary bg-secondary';
  }
}

// Function to update question status
async function updateQuestionStatus(questionId, status) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/questions/${questionId}/status`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status })
    });

    if (!response.ok) {
      throw new Error('Failed to update status');
    }

    loadQuestions(); // Reload questions to show updated status
  } catch (error) {
    console.error('Error updating status:', error);
    alert('Failed to update question status. Please try again.');
  }
}

// Function to submit answer
async function submitAnswer(questionId, answer) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_BASE}/questions/${questionId}/answer`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ answer })
    });

    if (!response.ok) {
      throw new Error('Failed to submit answer');
    }

    loadQuestions(); // Reload questions to show the answer
  } catch (error) {
    console.error('Error submitting answer:', error);
    alert('Failed to submit answer. Please try again.');
  }
}

// Load all questions for admin
// Show loading indicator
function showLoading() {
  const questionsList = document.getElementById('questionsList');
  questionsList.innerHTML = `
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Loading questions...</p>
    </div>
  `;
}

// Show error message
function showError(message) {
  const questionsList = document.getElementById('questionsList');
  questionsList.innerHTML = `
    <div class="alert alert-danger">
      <strong>Error:</strong> ${message}
      <button type="button" class="btn btn-link" onclick="loadQuestions()">Try Again</button>
    </div>
  `;
}

// Load all questions for admin
async function loadQuestions() {
  const questionsList = document.getElementById('questionsList');
  showLoading();
  
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
      return;
    }

    const response = await fetch(`${API_BASE}/questions/all`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to fetch questions');
    }
    
    const questions = await response.json();

    if (!questions || questions.length === 0) {
      questionsList.innerHTML = `
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          No questions found.
        </div>
      `;
      return;
    }

    // Create and display the stats and questions
    const statsHtml = createStatsSection(questions);
    const questionsHtml = questions.map(createQuestionCard).join('');
    
    questionsList.innerHTML = `
      ${statsHtml}
      <div class="row">
        ${questionsHtml}
      </div>
    `;

    questionsList.innerHTML = statsHtml;
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <h5 class="card-title">Total Questions</h5>
            <h2>${stats.total}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body">
            <h5 class="card-title">Pending</h5>
            <h2>${stats.pending}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <h5 class="card-title">Approved</h5>
            <h2>${stats.approved}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-danger text-white">
          <div class="card-body">
            <h5 class="card-title">Rejected</h5>
            <h2>${stats.rejected}</h2>
          </div>
        </div>
      </div>
    `;
    questionsList.appendChild(statsDiv);

    // Display questions
    questions.forEach(question => {
      const questionDiv = document.createElement('div');
      questionDiv.className = 'card mb-4';
      
      const statusClass = getStatusBadgeClass(question.status);
      const statusDisplay = question.status ? question.status.charAt(0).toUpperCase() + question.status.slice(1) : 'Unknown';

      questionDiv.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title">${question.questionText || 'No question text'}</h5>
            <span class="badge ${statusClass}">${statusDisplay}</span>
          </div>
          
          <div class="question-details mb-3">
            <div><small class="text-muted">Department: ${question.department || 'Not specified'}</small></div>
            <div><small class="text-muted">Asked by: ${question.user ? question.user.username : 'Unknown user'}</small></div>
            <div><small class="text-muted">Keywords: ${question.keywords && question.keywords.length > 0 ? question.keywords.join(', ') : 'No keywords'}</small></div>
            <div><small class="text-muted">Submitted: ${formatDate(question.createdAt)}</small></div>
          </div>

          ${question.file ? `
            <div class="mb-3">
              <strong>Attachment:</strong> 
              <a href="${API_BASE}/uploads/${question.file}" target="_blank" class="btn btn-sm btn-outline-primary">
                View File
              </a>
            </div>
          ` : ''}

          ${question.answer ? `
            <div class="alert alert-info mb-3">
              <strong>Answer:</strong>
              <p class="mt-2 mb-0">${question.answer}</p>
            </div>
          ` : ''}

          <div class="action-panel">
            <form onsubmit="event.preventDefault(); submitAnswer('${question._id}', document.getElementById('answer-${question._id}').value);">
              <div class="row g-3">
                <div class="col-md-8">
                  <div class="form-group">
                    <label class="form-label"><strong>Admin Response:</strong></label>
                    <textarea class="form-control" id="answer-${question._id}" 
                      placeholder="Write your answer here..."
                      rows="3">${question.answer || ''}</textarea>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label"><strong>Status:</strong></label>
                    <select class="form-select" onchange="updateQuestionStatus('${question._id}', this.value)">
                      <option value="pending" ${question.status === 'pending' ? 'selected' : ''}>Pending</option>
                      <option value="in-progress" ${question.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                      <option value="approved" ${question.status === 'approved' ? 'selected' : ''}>Approved</option>
                      <option value="rejected" ${question.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                  ${question.answer ? 'Update Answer' : 'Submit Answer'}
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
            <div class="status-toggle">
              <div class="btn-group" role="group">
                <button class="btn btn-sm ${question.status === 'pending' ? 'btn-warning active' : 'btn-outline-warning'}"
                        onclick="updateQuestionStatus('${question._id}', 'pending')">Pending</button>
                <button class="btn btn-sm ${question.status === 'in-progress' ? 'btn-info active' : 'btn-outline-info'}"
                        onclick="updateQuestionStatus('${question._id}', 'in-progress')">In Progress</button>
                <button class="btn btn-sm ${question.status === 'answered' ? 'btn-success active' : 'btn-outline-success'}"
                        onclick="updateQuestionStatus('${question._id}', 'answered')">Answered</button>
              </div>
            </div>
          </div>
          <div class="mb-2">
            <small class="text-muted">Department: ${question.department || 'Not specified'}</small><br>
            <small class="text-muted">
              Asked by: ${question.user ? question.user.username : 'Unknown'} on 
              ${question.createdAt ? formatDate(question.createdAt) : 'Date not available'}
            </small>
          </div>
          <div class="mb-3">
            <strong>Keywords:</strong> ${question.keywords || 'No keywords provided'}
          </div>
          ${question.answer ? `
            <div class="alert alert-info">
              <strong>Answer:</strong><br>
              ${question.answer}
            </div>
          ` : ''}
          <div class="answer-form mt-3">
            <div class="input-group">
              <textarea class="form-control" id="answer-${question._id}" 
                placeholder="Write your answer here..."
                rows="3">${question.answer || ''}</textarea>
              <button class="btn btn-primary" onclick="submitAnswer('${question._id}', document.getElementById('answer-${question._id}').value)">
                ${question.answer ? 'Update Answer' : 'Submit Answer'}
              </button>
            </div>
          </div>
        </div>
      `;
      questionsList.appendChild(card);
    });

    // Statistics section
    const statsDiv = document.createElement('div');
    statsDiv.className = 'row mb-4';
    const stats = {
      total: questions.length,
      pending: questions.filter(q => q.status === 'pending').length,
      approved: questions.filter(q => q.status === 'approved').length,
      rejected: questions.filter(q => q.status === 'rejected').length
    };
    
    statsDiv.innerHTML = `
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <h5 class="card-title">Total Questions</h5>
            <h2>${stats.total}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body">
            <h5 class="card-title">Pending</h5>
            <h2>${stats.pending}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <h5 class="card-title">Approved</h5>
            <h2>${stats.approved}</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-danger text-white">
          <div class="card-body">
            <h5 class="card-title">Rejected</h5>
            <h2>${stats.rejected}</h2>
          </div>
        </div>
      </div>
    `;
    questionsList.appendChild(statsDiv);
    questions.forEach(question => {
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-item';
      questionDiv.innerHTML = `
        <h3>Question from <span class="username">${question.user.username}</span></h3>
        <p>${question.questionText}</p>
        <p><strong>Keywords:</strong> ${question.keywords.join(', ')}</p>
        <p><strong>Department:</strong> ${question.department}</p>
        <p><strong>Status:</strong> 
          <select class="status-select" data-question-id="${question._id}">
            <option value="pending" ${question.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="reviewed" ${question.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
            <option value="approved" ${question.status === 'approved' ? 'selected' : ''}>Approved</option>
          </select>
        </p>
        ${question.file ? `<p><strong>Attachment:</strong> <a href="${API_BASE}/uploads/${question.file}" target="_blank">${question.file}</a></p>` : '<p><em>No attachment</em></p>'}
        <form class="answer-form" data-question-id="${question._id}">
          <label><strong>Admin Answer:</strong></label><br>
          <textarea rows="2" cols="60" name="answer" placeholder="Type your answer here...">${question.answer ? question.answer : ''}</textarea><br>
          <button type="submit">Save Answer</button>
        </form>
        <hr>
      `;
      questionsList.appendChild(questionDiv);
    });
  } catch (error) {
    console.error('Error loading questions:', error);
    document.getElementById('questionsList').innerHTML = 
      '<div class="alert alert-danger">Failed to load questions. Please try again.</div>';
  }
}

// Check if user is admin
function checkAdminAccess() {
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');
  
  if (!token || role !== 'admin') {
    alert('Admin access required. Please log in with an admin account.');
    window.location.href = 'login.html';
    return false;
  }
  return true;
}

// Show loading indicator
function showLoading() {
  const questionsList = document.getElementById('questionsList');
  questionsList.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading questions...</p>
    </div>
  `;
}

// Show error message
function showError(message) {
  const questionsList = document.getElementById('questionsList');
  questionsList.innerHTML = `
    <div class="alert alert-danger">
      <strong>Error:</strong> ${message}
      <button type="button" class="btn btn-link" onclick="loadQuestions()">Try Again</button>
    </div>
  `;
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
  if (checkAdminAccess()) {
    showLoading();
    loadQuestions().catch(error => {
      console.error('Error loading questions:', error);
      showError('Failed to load questions. Please try again.');
    });
  }
});
  loadQuestions();
});
